<style type="text/css">
  body{
    background-color: #FDFFFC;
  }
    .product-box {
        display: flex;
    }
    .product {
        display: flex;
        flex-direction: column;
    }
    .note-field--container {
        display: flex;
        flex-direction: column;
    }
</style>
<h1> TEST TEST  asdfs</h1>
<script type="text/javascript">
const selectedVariants = new Map();

function setAddDisabled(form) {
    const variantId = form.querySelector('[name="variant"]').value;
    const sectionId = form.querySelector('[name="section"]').value;
    const canAdd = window.BundleBuilder.canAddVariant(variantId, sectionId);
    form.querySelector('[type="submit"]').disabled = !canAdd;
}


/* Change variant price after variant change */
Array.prototype.forEach.call(
    document.querySelectorAll('.bundle-builder--add-to-bundle-form select[name="variant"]'),
    function (select) {
        select.addEventListener('change', function (e) {
            const variantId = e.target.value;
            selectedVariants.set(e.target.id, variantId);
            const price = e.target.querySelector('option[value="' + variantId + '"]').dataset.price;
            e.target.parentNode.querySelector('.variant-price').textContent = price;

           const form = e.target.parentElement;
           setAddDisabled(form);
        });
    }
);


function render() {
    selectedVariants.forEach(function (variantId, selectId) {
        const select = document.getElementById(selectId);
        if (select) {
            select.value = variantId;
        }
    });
    Array.prototype.forEach.call(
        document.querySelectorAll('.bundle-builder--add-to-bundle-form'),
        setAddDisabled,
    );
}
/* Change variant to what was selected last */
document.body.addEventListener('bundlebuilder:render', render);
render()
</script>
{% if bundle.published %}
<section class="container">
    <h1>{{ bundle.current_section.name }}</h1>
    <div class="product-box row">
      <div class="col-12 col-md-8">
        <div class="row">
        {% for product in bundle.current_section.products %}
        <div class="col mb-3 " data-loop-index="{{forloop.index}}">

          <div class="product-block card h-100 my-0">
            <div class="row no-gutters h-100">
              <div class="col col-md-4 product-block--img-wrapper">
                <div class="pink-skrim"></div>
                <img src="{{  product.featured_image.src | img_url: "medium" }}" class="product-block--img card-img" alt="{{product.title}}">
              </div>
              <div class="col col-md-8">
                <div class="card-body d-flex flex-column justify-content-between h-100">
                  <h5 class="card-title pb-0 mb-0 pt-0 pt-lg-3 mx-auto px-0 px-md-1">{{ product.title }}</h5>
                  <ul class="list-inline card-subtitle small text-muted my-0 py-0 product-card--highlights d-none d-lg-block">
                  {% for tag in product.tags %}
                  {% case tag %}
                    {% when 'highlight-vegan' %}
                         <li class="list-inline-item product-card--highlights-item font-italic">100% Vegan </li>
                      {% when 'highlight-gluten-free' %}
                        <li class="list-inline-item product-card--highlights-item font-italic">Gluten Free</li>
                      {% when 'highlight-yummy' %}
                        <li class="list-inline-item product-card--highlights-item font-italic">Super Yummy</li>
                      {% when 'highlight-dairy-free' %}
                        <li class="list-inline-item product-card--highlights-item font-italic">Dairy Free</li>
                      {% when 'highlight-no-nuts' %}
                        <li class="list-inline-item product-card--highlights-item font-italic" >No Nuts</li>
                      {% when 'highlight-low-carb' %}
                        <li class="list-inline-item product-card--highlights-item font-italic">Low Carb</li>
                    {% endcase %}
                  {% endfor %}
                  </ul>
                  <p class="card-text product-block py-1 my-2 text-left">{{ product.description | truncate: 100 }}</p>
                  <div>
                    {% add_to_bundle_form bundle.current_section %}
                        {% if product.available_variants.size > 1 %}
                            <select name="variant" id="select-{{ bundle.current_section.index }}-{{ product.id }}">
                                {% for variant in product.available_variants %}
                                    <option value="{{ variant.id }}" data-price={{ variant.price | money }}>
                                        {{ variant.title }}{% if variant.available_count %} (available: {{ variant.available_count }}){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <input type="hidden" name="variant" value="{{ product.available_variants[0].id }}" />
                            {{ product.available_variants[0].title }}{% if product.available_variants[0].available_count %} (available: {{ product.available_variants[0].available_count }}){% endif %}
                        {% endif %}
                        <span class="variant-price">{{ product.available_variants[0].price | money }}</span>
                        <button type="submit">Add</button>
                    {% end_add_to_bundle_form %}
                  </div>
                  {% for variant in product.variants_in_bundle %}
                    {% change_quantity_form %}
                        {{ variant.title }}
                        <input type="hidden" name="variant" value="{{ variant.id }}" />
                        <input type="hidden" name="section" value="{{ bundle.current_section.index }}" />
                        <button type="submit" name="remove">-</button>
                            {{ variant.count }}
                        <button type="submit" name="add">+</button>
                    {% end_change_quantity_form %}
                 {% endfor %}
                </div>
              </div>
            </div>
          </div>

        </div>
        {% endfor %}
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="row">

    {% if bundle.has_next_section %}
        {% section_switch_form %}
            <input type="hidden" name="section" value="{{ bundle.current_section.index | plus: 1 }}" />
            <button type="submit">Next</button>
        {% end_section_switch_form %}
    {% endif %}

    {% if bundle.has_prev_section %}
        {% section_switch_form %}
            <input type="hidden" name="section" value="{{ bundle.current_section.index | plus: -1 }}" />
            <button type="submit">Previous</button>
        {% end_section_switch_form %}
    {% endif %}

    {% if bundle.errors.size > 0 %}
        <ul>
            {% for error in bundle.errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="bundle-content">
        {% if bundle.content.items.size == 0 %}
            <span>Your bundle is empty</span>
        {% else %}
            <table>
                <tr>
                    <th>Product</th>
                    <th>Variant</th>
                    <th>Section</th>
                    <th>Price</th>
                    <th></th>
                </tr>
                {% for item in bundle.content.items %}
                    <tr>
                        <td>{{ item.variant.product.title }}</td>
                        <td>{{ item.variant.title }}</td>
                        <td>{{ item.section.name }}</td>
                        <td>{{ item.variant.price | money }}</td>
                        <td>
                            {% unless item.is_required %}
                                {% remove_from_bundle_form item %}
                                    <button type="submit">Remove</button>
                                {% end_remove_from_bundle_form %}
                            {% endunless %}
                        </td>
                    </tr>
                {% endfor %}
                {% if bundle.content.price < bundle.content.compare_at_price %}
                    <tr>
                        <th colspan="3">Discount</th>
                        <th>
                            <span>{{ bundle.content.price | minus: bundle.content.compare_at_price | money }}</span>
                        </th>
                        <th></th>
                    </tr>
                {% endif %}
                <tr>
                    <th colspan="3">Total</th>
                    <th>
                        <span>{{ bundle.content.price | money }}</span>
                    </th>
                    <th></th>
                </tr>
            </table>

            {% if settings.note_enabled %}
                <div class="note-field--container">
                    <label>{{ settings.note_label }}{% if settings.note_required %} (required){% endif %}</label>
                    {% note_field %}{{ settings.note_text }}{% end_note_field %}
                </div>
                {% if settings.note_prompt_visible %}
                    <div class="note-field--error-message">
                        <p>Note required before adding to cart.</p>
                    </div>
                {% endif %}
            {% endif %}

            {% add_to_cart_form %}
                {% if bundle.subscription_type == 'optional' and bundle.subscription_frequencies.size > 0 %}
                    <label>
                        <input type="radio" name="subscription-enabled" value="0" />
                        One-time purchase
                    </label>
                    <label>
                        <input type="radio" name="subscription-enabled" value="1" />
                        Subscribe
                    </label>
                {% endif %}
                {% if bundle.subscription_type == 'required' or bundle.subscription_enabled %}
                    {% for frequency in bundle.subscription_frequencies %}
                        <ul>
                            <li>
                                <label>
                                    <input type="radio" name="subscription-frequency" value="{{ frequency.id }}" />
                                    {{ frequency.frequency }} {{ frequency.unit }}
                                </label>
                            </li>
                        </ul>
                    {% endfor %}
                    Email: <input type="email" required name="subscription-email" value="{{ settings.subscription_email }}" />
                {% endif %}
                <button type="submit"{% unless bundle.can_add_to_cart %} disabled="disabled"{% endunless %}>
                    {% if bundle.adding_to_cart %}
                        Processing...
                    {% else %}
                        Add bundle to cart
                    {% endif %}
                </button>
            {% end_add_to_cart_form %}
        {% endif %}
      </div>
      </div>
    </div>
    </div>
  </section>
{% else %}
    <p>Sorry, this bundle is currently unavailable.</p>
{% endif %}
